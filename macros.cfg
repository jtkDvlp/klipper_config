[gcode_macro HOME]
gcode:
  G28
  G90

[gcode_macro HOMED]
gcode:
  {% if not ('x' in printer.toolhead.homed_axes and 'y' in printer.toolhead.homed_axes and 'z' in printer.toolhead.homed_axes) %}
    HOME
  {% endif %}
  G90

[gcode_macro HOME_N_LEVEL]
gcode:
  BED_MESH_CLEAR
  G28
  QUAD_GANTRY_LEVEL
  G28 Z

[gcode_macro LIFT]
gcode:
  SAVE_GCODE_STATE NAME=REAR_state
  HOMED
  G91
  G0 Z{params.Z|default(10)} F3600
  RESTORE_GCODE_STATE NAME=REAR_state

[gcode_macro PARK]
gcode:
  SAVE_GCODE_STATE NAME=REAR_state
  HOMED
  G0 X25 Y310 F3600
  RESTORE_GCODE_STATE NAME=REAR_state

[gcode_macro LIFT_N_PARK]
gcode:
  LIFT
  PARK

[gcode_macro CENTER]
gcode:
  SAVE_GCODE_STATE NAME=CENTER_state
  HOMED
  G0 X150 Y150 F3600
  RESTORE_GCODE_STATE NAME=CENTER_state

[gcode_macro TOOLHEAD]
gcode:
  SAVE_GCODE_STATE NAME=TOOLHEAD_state
  HOMED
  G0 X150 Y0 F3600
  RESTORE_GCODE_STATE NAME=TOOLHEAD_state

[gcode_macro HEAT_CHAMBER]
gcode:
  {% set TEMP = (params.TEMP|float) %}
  HOMED
  G0 Z30 F3600
  CENTER
  M106
  M140 S120
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={TEMP}
  TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={(TEMP|float * 0.8)|round}
  M140 S{TEMP}
  M107

[gcode_macro M141]
gcode:
  HEAT_CHAMBER TEMP={params.S}

[gcode_macro M900]
gcode:
  SET_PRESSURE_ADVANCE ADVANCE={params.K|default(0)}

[gcode_macro TAKE_FLEXPLATE]
gcode:
  LIFT_N_PARK

[gcode_macro CHECK_FLEXPLATE]
gcode:
  SAVE_GCODE_STATE NAME=CHECK_FLEXPLATE_state
  CENTER
  G90
  G0 Z0.5 F6000
  QUERY_PROBE
  _CHECK_FLEXPLATE_PRESENT
  G0 Z20 F6000
  RESTORE_GCODE_STATE NAME=CHECK_FLEXPLATE_state

[gcode_macro _CHECK_FLEXPLATE_PRESENT]
gcode:
  {% if not printer.probe.last_query %}
    TURN_OFF_HEATERS
    G0 Z25 F6000
    BASE_CANCEL_PRINT
    _FLEXPLATE_ERROR
  {% endif %}

[gcode_macro _FLEXPLATE_ERROR]
gcode:   
    { action_raise_error('A stupid idiot forgot to put the flexplate on the bed! (Or the probe is not working.)') }

[gcode_macro CLEAN_NOZZLE]
gcode:
  SAVE_GCODE_STATE NAME=BRUSH_NOZZLE_state
  LIFT
  G0 X50 Y305 F3600
  G0 Z2.5 F3600
  G91
  G0 X50 F10000
  G0 X-50 F10000
  G0 X50 F10000
  G0 X-50 F10000
  G0 Y5 F10000
  G0 X10 Y-10 F10000
  G0 X10 Y10 F10000
  G0 X10 Y-10 F10000
  G0 X15 Y10 F10000
  G0 X-15 Y-10 F10000
  G0 X-10 Y10 F10000
  G0 X-10 Y-10 F10000
  G0 X-10 Y10 F10000
  G0 Y-5 F10000
  G0 X50 F10000
  G0 X-50 F10000
  G0 X50 F10000
  G0 X-50 F10000
  G0 Y5 F10000
  G0 X10 Y-10 F10000
  G0 X10 Y10 F10000
  G0 X10 Y-10 F10000
  G0 X15 Y10 F10000
  G0 X-15 Y-10 F10000
  G0 X-10 Y10 F10000
  G0 X-10 Y-10 F10000
  G0 X-10 Y10 F10000
  G0 Y-5 F10000
  G0 X50 F10000
  G0 X-50 F10000
  G0 X50 F10000
  G0 X-50 F10000
  G0 Y5 F10000
  RESTORE_GCODE_STATE NAME=BRUSH_NOZZLE_state

[gcode_macro PURGE_NOZZLE]
gcode:
  SAVE_GCODE_STATE NAME=PURGE_NOZZLE_state
  LIFT
  G0 X25 Y310 F3600
  G0 Z10
  G91
  G1 E{params.PURGE|default(20)} F300 
  G1 E-3.0 F3600
  RESTORE_GCODE_STATE NAME=PURGE_NOZZLE_state

[gcode_macro PURGE_N_CLEAN_NOZZLE]
gcode:
  PURGE_NOZZLE
  CLEAN_NOZZLE

[gcode_macro FILAMENT_UNLOAD]
gcode:
  SAVE_GCODE_STATE NAME=FILAMENT_UNLOAD_state
  LIFT_N_PARK
  M109 S{EXTRUDER|default(220)}
  G91
  G1 E-100 F300
  G90
  M109 S0
  RESTORE_GCODE_STATE NAME=FILAMENT_UNLOAD_state

[gcode_macro FILAMENT_LOAD]
gcode:
  SAVE_GCODE_STATE NAME=FILAMENT_LOAD_state
  LIFT_N_PARK
  M109 S{EXTRUDER|default(220)}
  G91
  G1 E67 F300
  G90
  PURGE_N_CLEAN_NOZZLE PURGE=100
  M109 S0
  RESTORE_GCODE_STATE NAME=FILAMENT_LOAD_state

[gcode_macro TAKE_PRINT]
gcode:
  TAKE_FLEXPLATE

[gcode_macro CALI_MESH]
gcode:
  HEAT_CHAMBER TEMP=40
  HOME_N_LEVEL
  BED_MESH_CALIBRATE
  SAVE_CONFIG

[gcode_macro PRINT_START]
gcode:
  SAVE_GCODE_STATE NAME=PRINT_START_state
  {% set EXTRUDER = params.EXTRUDER|int %}
  {% set BED = params.BED|int %}
  {% set CHAMBER = params.CHAMBER|default(0)|int %}
  CLEAR_PAUSE
  HEAT_CHAMBER TEMP={CHAMBER}
  M190 S{BED}
  CHECK_FLEXPLATE
  HOME_N_LEVEL
  LIFT_N_PARK
  M109 S{EXTRUDER}
  PURGE_N_CLEAN_NOZZLE
  LIFT_N_PARK
  CENTER
  LED_ON
  RESTORE_GCODE_STATE NAME=PRINT_START_state
  BED_MESH_PROFILE LOAD=default

[gcode_macro PRINT_END]
gcode:
    SAVE_GCODE_STATE NAME=PRINT_END_state
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z20 F3000                    ; move nozzle up
    G90                            ; absolute positioning
    PARK
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=30
    TAKE_PRINT
    M84 ; turn off motors
    LED_OFF
    RESTORE_GCODE_STATE NAME=PRINT_END_state